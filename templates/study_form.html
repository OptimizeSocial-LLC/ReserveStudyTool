{# templates/study_form.html #}
{% extends "base.html" %}
{% block content %}

<section class="page-header">
  <h1>{{ "Edit Reserve Study" if edit_mode else "New Reserve Study" }}</h1>
  <p>{{ prop.name }}</p>
</section>

<div class="form-actions" style="margin-bottom: 14px; display:flex; gap:10px; flex-wrap:wrap;">
  <a href="{{ url_for('property_page', property_id=prop.id) }}" class="btn-outline-sm">← Back to property</a>
  <a href="{{ url_for('home') }}" class="btn-outline-sm">Home</a>

  {% if edit_mode and study and study.is_paid %}
    <a href="{{ url_for('study_detail', study_id=study.id) }}" class="btn-outline-sm">Back to study</a>
  {% endif %}
</div>

{% set is_admin_user = (current_user and current_user.is_admin) %}
{% set isLockedForUser = (edit_mode and study and study.is_paid and not is_admin_user) %}
{% set ws = (study.workflow_status or "").lower() if study else "" %}

{% if edit_mode and study and study.is_paid and not is_admin_user %}
  <div class="panel" style="margin-bottom:14px;">
    <div class="panel-header">
      <h2>Locked</h2>
      <p>This study has been paid and is locked for editing.</p>
    </div>
    <div class="form-actions" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn-primary-sm" href="{{ url_for('study_detail', study_id=study.id) }}">View results</a>
    </div>
  </div>
{% endif %}

{% if is_admin_user and edit_mode and study and study.is_paid %}
  <div class="panel" style="margin-bottom:14px;">
    <div class="panel-header">
      <h2>Admin mode</h2>
      <p>This study is paid, but admins can still edit.</p>
    </div>

    {% if ws in ["paid_awaiting_review", "paid_pending_admin_build"] %}
      <div class="form-actions" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <form method="post" action="{{ url_for('admin_approve', study_id=study.id) }}">
          <button type="submit" class="btn-primary-sm">Complete &amp; approve</button>
        </form>
        <span style="color:var(--text-muted); font-size:13px; align-self:center;">
          This publishes the final report to the customer’s account.
        </span>
      </div>
    {% endif %}
  </div>
{% endif %}

<section class="upload-card">
  <form class="upload-form"
        action="{{ url_for('create_study') if not edit_mode else url_for('update_study', study_id=study.id) }}"
        method="post">
    <input type="hidden" name="property_id" value="{{ prop.id }}" />
    <input type="hidden" name="tier" value="{{ tier if tier is defined else (study.tier if study else 'essentials') }}" />

    <div class="forecast-layout" style="margin-top: 0;">
      <!-- Left panel -->
      <div class="panel">
        <div class="panel-header">
          <h2>Study assumptions</h2>
          <p>Full Funding (FFB + % funded) with a levelized contribution recommendation.</p>
        </div>

        <div style="margin-top: 12px; display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-row" style="margin-bottom:0;">
            <label for="start_year">Start year</label>
            <input type="number" id="start_year" name="start_year"
                   value="{{ defaults.start_year if edit_mode else '' }}"
                   placeholder="i.e. 2026"
                   {% if isLockedForUser %}disabled{% endif %} />
            <div class="field-help">First year in the projection.</div>
          </div>

          <div class="form-row" style="margin-bottom:0;">
            <label for="horizon_years">Horizon (years)</label>
            <input type="number" id="horizon_years" name="horizon_years"
                   value="{{ defaults.horizon_years if edit_mode else '' }}"
                   placeholder="i.e. 30"
                   {% if isLockedForUser %}disabled{% endif %} />
            <div class="field-help">How many years to model (typical: 20–30).</div>
          </div>

          <div class="form-row" style="margin-bottom:0;">
            <label for="inflation_rate">Inflation / escalation rate</label>
            <input type="number" step="0.0001" id="inflation_rate" name="inflation_rate"
                   value="{{ defaults.inflation_rate if edit_mode else '' }}"
                   placeholder="i.e. 0.03"
                   {% if isLockedForUser %}disabled{% endif %} />
            <div class="field-help">Example: <code>0.03</code> for 3%.</div>
          </div>

          <div class="form-row" style="margin-bottom:0;">
            <label for="interest_rate">Interest / earnings rate</label>
            <input type="number" step="0.0001" id="interest_rate" name="interest_rate"
                   value="{{ defaults.interest_rate if edit_mode else '' }}"
                   placeholder="i.e. 0.01"
                   {% if isLockedForUser %}disabled{% endif %} />
            <div class="field-help">Example: <code>0.01</code> for 1%.</div>
          </div>

          <div class="form-row" style="margin-bottom:0;">
            <label for="starting_balance">Starting reserve balance ($)</label>
            <input type="number" step="0.01" id="starting_balance" name="starting_balance"
                   value="{{ defaults.starting_balance if edit_mode else '' }}"
                   placeholder="i.e. 50000"
                   {% if isLockedForUser %}disabled{% endif %} />
            <div class="field-help">What’s currently in the reserve account.</div>
          </div>

          <div class="form-row" style="margin-bottom:0;">
            <label for="min_balance">Minimum balance ($)</label>
            <input type="number" step="0.01" id="min_balance" name="min_balance"
                   value="{{ defaults.min_balance if edit_mode else '' }}"
                   placeholder="i.e. 0"
                   {% if isLockedForUser %}disabled{% endif %} />
            <div class="field-help">Use a buffer if needed.</div>
          </div>

          <div class="form-row" style="margin-bottom:0;">
            <label for="funding_method">Funding method</label>
            <select id="funding_method" name="funding_method"
                    {% if isLockedForUser %}disabled{% endif %}>
              <option value="full" {% if (defaults.funding_method or 'full') == 'full' %}selected{% endif %}>
                Full Funding (FFB + % funded)
              </option>
            </select>
          </div>

          <div class="form-row" style="margin-bottom:0;">
            <label for="contribution_mode">Contribution style</label>
            <select id="contribution_mode" name="contribution_mode"
                    {% if isLockedForUser %}disabled{% endif %}>
              <option value="levelized" {% if (defaults.contribution_mode or 'levelized') == 'levelized' %}selected{% endif %}>
                Levelized (one annual amount)
              </option>
            </select>
          </div>
        </div>
      </div>

      <!-- Right panel -->
      <div class="panel">
        <div class="panel-header table-header" style="display:flex; align-items:flex-start; justify-content:space-between; gap:14px;">
          <div>
            <h2>Components</h2>
            <p>Enter the major items your HOA is responsible for replacing (roof, paint, paving, etc.).</p>
          </div>

          <div>
            <button type="button" class="btn-outline-sm" id="add-component-btn"
                    {% if isLockedForUser %}disabled{% endif %}>
              + Add
            </button>
          </div>
        </div>

        <div id="components-wrap" style="margin-top: 12px;">
          {% for c in components %}
            <div class="panel component-row"
                 data-component-id="{{ c.id if c.id is defined else '' }}"
                 style="padding: 14px; margin-bottom: 12px;">

              <input type="hidden" name="component_id[]" value="{{ c.id if c.id is defined else '' }}" />
              <input type="hidden" class="js-rowkey-input" name="row_key[]" value="{{ c.row_key if c.row_key is defined else '' }}" />

              <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px;">
                <div style="font-size:12px; color: var(--text-muted);">Component</div>
                <button type="button" class="btn-outline-sm js-remove-component" style="padding:6px 10px;"
                        {% if isLockedForUser %}disabled{% endif %}>
                  Delete
                </button>
              </div>

              <div style="display:grid; grid-template-columns: 1.2fr 1fr; gap: 10px;">
                <div class="form-row" style="margin-bottom:0;">
                  <label style="margin-bottom:6px;">Name</label>
                  <input name="component_name[]" type="text"
                         value="{{ c.name if edit_mode else (c.name or '') }}"
                         placeholder="i.e. Roof"
                         {% if isLockedForUser %}disabled{% endif %}/>
                </div>

                <div class="form-row" style="margin-bottom:0;">
                  <label style="margin-bottom:6px;">Replacement cost (today $)</label>
                  <input name="current_replacement_cost[]" type="number" step="0.01"
                         value="{{ "{:.2f}".format(c.current_replacement_cost) if (edit_mode and c.current_replacement_cost is not none) else '' }}"
                         placeholder="i.e. 180000"
                         {% if isLockedForUser %}disabled{% endif %}/>
                </div>
              </div>

              <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px;">
                <div class="form-row" style="margin-bottom:0;">
                  <label style="margin-bottom:6px;">Quantity</label>
                  <input name="quantity[]" type="number"
                         value="{{ c.quantity if edit_mode else '' }}"
                         placeholder="i.e. 1"
                         {% if isLockedForUser %}disabled{% endif %}/>
                </div>

                <div class="form-row" style="margin-bottom:0;">
                  <label style="margin-bottom:6px;">Cycle (years)</label>
                  <input name="cycle_years[]" type="number"
                         value="{{ c.cycle_years if edit_mode else '' }}"
                         placeholder="i.e. 25"
                         {% if isLockedForUser %}disabled{% endif %}/>
                  <div class="field-help">Usually equals Useful Life. Can differ.</div>
                </div>
              </div>

              <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px;">
                <div class="form-row" style="margin-bottom:0;">
                  <label style="margin-bottom:6px;">Useful life (years)</label>
                  <input name="useful_life_years[]" type="number"
                         value="{{ c.useful_life_years if edit_mode else '' }}"
                         placeholder="i.e. 25"
                         {% if isLockedForUser %}disabled{% endif %}/>
                </div>

                <div class="form-row" style="margin-bottom:0;">
                  <label style="margin-bottom:6px;">Remaining life (years)</label>
                  <input name="remaining_life_years[]" type="number"
                         value="{{ c.remaining_life_years if edit_mode else '' }}"
                         placeholder="i.e. 8"
                         {% if isLockedForUser %}disabled{% endif %}/>
                </div>
              </div>

              <!-- Photos (AUTO-UPLOAD on choose) -->
              <div class="component-photos" style="margin-top:12px;">
                <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px; flex-wrap:wrap;">
                  <div>
                    <div style="font-size:12px; color: var(--text-muted);">Photos (optional)</div>
                    <div style="font-size:13px; color: var(--text-muted); margin-top:2px;">
                      Choose files → upload automatically → thumbnails show below.
                    </div>
                  </div>

                  {% if not isLockedForUser %}
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                      <input class="js-photo-input" type="file" accept="image/*" multiple />
                    </div>
                  {% endif %}
                </div>

                <div class="js-photo-status" style="margin-top:8px; font-size:13px; color: var(--text-muted);"></div>

                <div class="js-photo-grid"
                     style="margin-top:10px; display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:10px;">
                  {% if c.photos is defined and c.photos %}
                    {% for p in c.photos %}
                      <div class="js-photo-card"
                           data-kind="saved"
                           data-photo-id="{{ p.id }}"
                           style="border:1px solid rgba(255,255,255,0.10); border-radius:12px; overflow:hidden; background:rgba(255,255,255,0.03);">
                        <img src="{{ p.url }}" alt="{{ p.name or 'photo' }}"
                             style="width:100%; height:100px; object-fit:cover;" loading="lazy" />
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px;">
                          <div style="font-size:12px; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            {{ p.name or "Photo" }}
                          </div>
                          {% if not isLockedForUser %}
                            <button type="button" class="btn-outline-sm js-delete-photo" style="padding:6px 10px;">Remove</button>
                          {% endif %}
                        </div>
                      </div>
                    {% endfor %}
                  {% endif %}
                </div>
              </div>

            </div>
          {% endfor %}
        </div>

        <p class="disclaimer-line" style="margin-top: 6px;">
          Tip: Most HOA managers can confidently identify 10–25 components. Start with big-ticket items.
        </p>
      </div>
    </div>

    <div class="form-actions" style="margin-top: 14px; display:flex; gap:10px; flex-wrap:wrap;">
      <button type="submit" class="btn-primary-sm"
              {% if isLockedForUser %}disabled{% endif %}>
        Save draft
      </button>

      <a href="{{ url_for('property_page', property_id=prop.id) }}" class="btn-outline-sm">Cancel</a>

      {% if edit_mode and study and not study.is_paid %}
        <a href="{{ url_for('checkout', study_id=study.id) }}" class="btn-outline-sm">Checkout</a>
      {% endif %}
    </div>
  </form>
</section>

<script>
(function () {
  const isLocked = {{ "true" if isLockedForUser else "false" }};
  if (isLocked) return;

  function uuidRowKey() {
    return "rk_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }

  function qs(el, sel) { return el.querySelector(sel); }
  function qsa(el, sel) { return Array.from(el.querySelectorAll(sel)); }

  function setStatus(rowEl, msg) {
    const s = qs(rowEl, ".js-photo-status");
    if (s) s.textContent = msg || "";
  }

  function renderPhotoGrid(rowEl, photos, kind) {
    const grid = qs(rowEl, ".js-photo-grid");
    if (!grid) return;
    grid.innerHTML = "";

    (photos || []).forEach(p => {
      const card = document.createElement("div");
      card.className = "js-photo-card";
      card.dataset.kind = kind;
      card.dataset.photoId = p.id;

      card.style.border = "1px solid rgba(255,255,255,0.10)";
      card.style.borderRadius = "12px";
      card.style.overflow = "hidden";
      card.style.background = "rgba(255,255,255,0.03)";

      const img = document.createElement("img");
      img.src = p.url;
      img.alt = p.name || "photo";
      img.loading = "lazy";
      img.style.width = "100%";
      img.style.height = "100px";
      img.style.objectFit = "cover";

      const footer = document.createElement("div");
      footer.style.display = "flex";
      footer.style.justifyContent = "space-between";
      footer.style.alignItems = "center";
      footer.style.gap = "8px";
      footer.style.padding = "8px";

      const name = document.createElement("div");
      name.textContent = p.name || "Photo";
      name.style.fontSize = "12px";
      name.style.color = "var(--text-muted)";
      name.style.whiteSpace = "nowrap";
      name.style.overflow = "hidden";
      name.style.textOverflow = "ellipsis";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn-outline-sm js-delete-photo";
      btn.textContent = "Remove";
      btn.style.padding = "6px 10px";

      footer.appendChild(name);
      footer.appendChild(btn);

      card.appendChild(img);
      card.appendChild(footer);
      grid.appendChild(card);
    });
  }

  async function fetchJson(url, opts) {
    const res = await fetch(url, opts || {});
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      const msg = (data && (data.error || data.message)) || ("Request failed: " + res.status);
      throw new Error(msg);
    }
    return data;
  }

  async function refreshPhotos(rowEl) {
    const componentId = (rowEl.dataset.componentId || "").trim();
    const propId = (document.querySelector('input[name="property_id"]')?.value || "").trim();
    const rowKeyInput = qs(rowEl, ".js-rowkey-input");
    const rowKey = (rowKeyInput?.value || "").trim();

    if (componentId) {
      const data = await fetchJson(`/components/${componentId}/photos`);
      renderPhotoGrid(rowEl, data.photos || [], "saved");
      return;
    }

    if (propId && rowKey) {
      const data = await fetchJson(`/temp/component-photos?property_id=${encodeURIComponent(propId)}&row_key=${encodeURIComponent(rowKey)}`);
      renderPhotoGrid(rowEl, data.photos || [], "temp");
      return;
    }

    renderPhotoGrid(rowEl, [], "temp");
  }

  async function uploadFilesForRow(rowEl, fileList) {
    const files = Array.from(fileList || []);
    if (!files.length) return;

    const componentId = (rowEl.dataset.componentId || "").trim();
    const propId = (document.querySelector('input[name="property_id"]')?.value || "").trim();
    const rowKeyInput = qs(rowEl, ".js-rowkey-input");

    if (!componentId) {
      if (rowKeyInput && !rowKeyInput.value.trim()) {
        rowKeyInput.value = uuidRowKey();
      }
    }

    setStatus(rowEl, "Uploading…");

    if (componentId) {
      const fd = new FormData();
      files.forEach(f => fd.append("photos", f));

      await fetchJson(`/components/${componentId}/photos`, {
        method: "POST",
        body: fd
      });

      await refreshPhotos(rowEl);
      setStatus(rowEl, "Uploaded.");
      setTimeout(() => setStatus(rowEl, ""), 1200);
      return;
    }

    if (!propId) throw new Error("Missing property_id");
    const rowKey = (rowKeyInput?.value || "").trim();
    if (!rowKey) throw new Error("Missing row_key");

    const fd = new FormData();
    fd.append("property_id", propId);
    fd.append("row_key", rowKey);
    files.forEach(f => fd.append("photos", f));

    await fetchJson(`/temp/component-photo`, {
      method: "POST",
      body: fd
    });

    await refreshPhotos(rowEl);
    setStatus(rowEl, "Uploaded.");
    setTimeout(() => setStatus(rowEl, ""), 1200);
  }

  document.addEventListener("change", async (e) => {
    const input = e.target;
    if (!(input instanceof HTMLInputElement)) return;
    if (!input.classList.contains("js-photo-input")) return;

    const rowEl = input.closest(".component-row");
    if (!rowEl) return;

    try {
      await uploadFilesForRow(rowEl, input.files);
      input.value = "";
    } catch (err) {
      setStatus(rowEl, (err && err.message) ? err.message : "Upload failed.");
      input.value = "";
    }
  });

  document.addEventListener("click", async (e) => {
    const btn = e.target;
    if (!(btn instanceof HTMLElement)) return;
    if (!btn.classList.contains("js-delete-photo")) return;

    const card = btn.closest(".js-photo-card");
    const rowEl = btn.closest(".component-row");
    if (!card || !rowEl) return;

    const kind = card.dataset.kind;
    const photoId = card.dataset.photoId;
    if (!photoId) return;

    try {
      setStatus(rowEl, "Removing…");
      if (kind === "saved") {
        await fetchJson(`/components/photos/${photoId}`, { method: "DELETE" });
      } else {
        await fetchJson(`/temp/component-photo/${photoId}`, { method: "DELETE" });
      }
      await refreshPhotos(rowEl);
      setStatus(rowEl, "");
    } catch (err) {
      setStatus(rowEl, (err && err.message) ? err.message : "Remove failed.");
    }
  });

  window.addEventListener("load", () => {
    qsa(document, ".component-row").forEach(rowEl => {
      refreshPhotos(rowEl).catch(() => {});
    });
  });
})();
</script>

{{ super() }}
{% endblock %}























