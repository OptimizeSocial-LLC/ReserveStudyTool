{# templates/study_pending_review.html #}
{% extends "base.html" %}
{% block content %}

<section class="page-header">
  <h1>{{ study.property.name }} — Study created on {{ study.created_at.strftime("%Y-%m-%d") }}</h1>
  <p>Status: <strong>Plus — paid (awaiting expert approval)</strong></p>
</section>

<div class="panel">
  <div class="panel-header">
    <h2>Payment received</h2>
    <p>
      You’re all set. An expert will review your inputs, make any needed edits, then approve and publish your final report.
      <br/>
      <span style="color:var(--text-muted); font-size:13px;">While you wait, you can review the exact inputs you submitted below (read-only).</span>
    </p>
  </div>

  <div class="form-actions" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
    <a class="btn-outline-sm" href="{{ url_for('property_page', property_id=study.property_id) }}">Back to property</a>
    <a class="btn-outline-sm" href="{{ url_for('home') }}">Home</a>
  </div>

  {% if current_user and current_user.is_admin %}
    <div class="panel" style="margin-top:14px;">
      <div class="panel-header">
        <h2>Admin actions</h2>
        <p>Edit the study, then approve to publish it to the customer.</p>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <a class="btn-primary-sm" href="{{ url_for('edit_study', study_id=study.id) }}">Edit study</a>
        <form method="post" action="{{ url_for('admin_approve', study_id=study.id) }}">
          <button type="submit" class="btn-primary-sm">Complete &amp; approve</button>
        </form>
      </div>
    </div>
  {% endif %}
</div>

<div class="panel" style="margin-top:14px;">
  <div class="panel-header">
    <h2>Submitted assumptions</h2>
    <p>Read-only snapshot of what was submitted at checkout.</p>
  </div>

  <div style="display:flex; flex-wrap:wrap; gap:14px; margin-top:12px;">
    <div class="panel" style="padding:12px; min-width:260px;">
      <div style="font-size:12px; color:var(--text-muted); margin-bottom:6px;">Assumptions</div>
      <div>Start year: {{ study.start_year }}</div>
      <div>Horizon: {{ study.horizon_years }} years</div>
      <div>Inflation: {{ "{:.2%}".format(study.inflation_rate) }}</div>
      <div>Interest: {{ "{:.2%}".format(study.interest_rate) }}</div>
      <div>Starting balance: ${{ "{:,.0f}".format(study.starting_balance) }}</div>
      <div>Minimum balance: ${{ "{:,.0f}".format(study.min_balance) }}</div>
      <div>Funding method: {{ study.funding_method }}</div>
      <div>Contribution style: {{ study.contribution_mode }}</div>
    </div>
  </div>
</div>

<div class="panel" style="margin-top:14px;">
  <div class="panel-header">
    <h2>Submitted components</h2>
    <p>Read-only snapshot of your component list and uploaded photos.</p>
  </div>

  {% if not components %}
    <div style="margin-top:10px; color:var(--text-muted);">
      No components found.
    </div>
  {% else %}
    <div style="overflow:auto;">
      <table class="table"
             style="
               width:100%;
               margin-top:10px;
               border-collapse:collapse;
               table-layout:fixed;
               min-width:980px;
             ">
        <colgroup>
          <col style="width:20%;">
          <col style="width:8%;">
          <col style="width:8%;">
          <col style="width:8%;">
          <col style="width:10%;">
          <col style="width:12%;">
          <col style="width:34%;">
        </colgroup>

        <thead>
          <tr>
            <th style="text-align:left; white-space:nowrap; padding:10px 12px;">Name</th>
            <th style="text-align:left; white-space:nowrap; padding:10px 12px;">Qty</th>
            <th style="text-align:left; white-space:nowrap; padding:10px 12px;">UL</th>
            <th style="text-align:left; white-space:nowrap; padding:10px 12px;">RL</th>
            <th style="text-align:left; white-space:nowrap; padding:10px 12px;">Cycle</th>
            <th style="text-align:right; white-space:nowrap; padding:10px 12px;">Cost</th>
            <th style="text-align:left; white-space:nowrap; padding:10px 12px;">Photos</th>
          </tr>
        </thead>

        <tbody>
          {% for c in components %}
            <tr>
              <td style="text-align:left; padding:10px 12px; vertical-align:top;">{{ c.name }}</td>
              <td style="text-align:left; padding:10px 12px; vertical-align:top;">{{ c.quantity }}</td>
              <td style="text-align:left; padding:10px 12px; vertical-align:top;">{{ c.useful_life_years }}</td>
              <td style="text-align:left; padding:10px 12px; vertical-align:top;">{{ c.remaining_life_years }}</td>
              <td style="text-align:left; padding:10px 12px; vertical-align:top;">{{ c.cycle_years }}</td>
              <td style="text-align:right; padding:10px 12px; vertical-align:top;">
                ${{ "{:,.0f}".format(c.current_replacement_cost) }}
              </td>

              <td style="text-align:left; padding:10px 12px; vertical-align:top;">
                {% set photos = comp_photos.get(c.id, []) %}
                {% if photos %}
                  <div style="
                    display:grid;
                    grid-template-columns: repeat(4, 64px);
                    gap:8px;
                    align-content:start;
                    justify-content:start;
                  ">
                    {% for p in photos %}
                      <a href="{{ p.url }}" target="_blank" rel="noopener"
                         title="{{ p.name or 'Photo' }}"
                         style="
                           display:block;
                           width:64px;
                           height:48px;
                           border:1px solid rgba(255,255,255,0.10);
                           border-radius:10px;
                           overflow:hidden;
                           background:rgba(255,255,255,0.03);
                         ">
                        <img src="{{ p.url }}" alt="{{ p.name or 'photo' }}"
                             style="width:64px; height:48px; object-fit:cover; display:block;"
                             loading="lazy" />
                      </a>
                    {% endfor %}
                  </div>
                {% else %}
                  <span style="color:var(--text-muted); font-size:13px;">—</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <p class="disclaimer-line" style="margin-top: 10px;">
      Tip: Click a thumbnail to open the full image in a new tab.
    </p>
  {% endif %}
</div>

{% endblock %}


